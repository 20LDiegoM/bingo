name: Deploy Bingo to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via Cloudflare Access
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          cloudflared access tcp \
            --hostname ssh.murcia-dev.com \
            --url localhost:2222 \
            --service-token-id $CF_ACCESS_CLIENT_ID \
            --service-token-secret $CF_ACCESS_CLIENT_SECRET &
          
          sleep 5

          ssh -o StrictHostKeyChecking=no -p 2222 luis@localhost \
            "cd ~/docker/murcia-dev/bingo && git fetch --all && git reset --hard origin/main && docker restart bingo_site"